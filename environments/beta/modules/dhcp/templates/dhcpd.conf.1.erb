# Generated by puppet module dhcp

#
# DHCP Server Configuration file.
#   see /usr/share/doc/dhcp*/dhcpd.conf.sample
#   see 'man 5 dhcpd.conf'
#

ddns-update-style interim;

update-static-leases on;

key dhcpupdate {
    algorithm hmac-md5;
    secret <%= @secret %>;
}
<%
    zone = @zone
    dhcpserver = @dhcpserver
    nameserver = zone['nameserver']
    gateway    = zone['gateway']
    pxeserver  = zone['pxeserver']
-%>

zone <%= zone['name'] %> {
    primary <%= nameserver['ip'] %>;
    key dhcpupdate;
}

zone <%= zone['reverse'] %>.IN-ADDR.ARPA {
    primary <%= nameserver['ip'] %>;
    key dhcpupdate;
}

ignore client-updates;

DHCPD_INTERFACE="<%= dhcpserver['interface'] %>";

option handshake code 251 = text;

subnet <%= zone['subnet'] %> netmask <%= zone['mask'] %> { 
    option handshake            "valid-server";
    option subnet-mask          <%= zone['mask'] %>;
    option routers              <%= gateway['ip'] %>;
    option domain-name-servers  <%= nameserver['ip'] %>;

    default-lease-time          21600;
    max-lease-time              432000;
    ddns-domainname             "<%= zone['name'] %>";
    option domain-name          "<%= zone['name'] %>";

    class "valid-clients" {
        match if (option handshake) = "valid-clients";
    }

    pool {
        range <%= dhcpserver['pool'] %>;
        allow members of "valid-clients";
    }

    group {
        allow                   booting;
        allow                   bootp;
        filename                "/pxelinux.0";
        next-server             <%= pxeserver['ip'] %>;
<% 
dhcpserver['fixed'].each do |host|
-%>
        host <%= host['name'] %> {
            hardware ethernet    <%= host['mac'] %>;
            option host-name    "<%= host['name'] %>";
            ddns-hostname       "<%= host['name'] %>";
            fixed-address        <%= host['ip'] %>;
        }
<% end -%>
    }
}
